<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluentGen - Gere Padrões de Frases em Inglês com IA</title>
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icon-180.png">
    <link rel="shortcut icon" type="image/png" href="assets/icon-180.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icon-180.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, rgba(22, 27, 34, 0.9) 0%, rgba(13, 17, 23, 0.95) 100%);
            color: #c9d1d9;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: -1;
        }
        
        @keyframes backgroundShift {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-20px) translateY(-10px); }
            50% { transform: translateX(20px) translateY(10px); }
            75% { transform: translateX(-10px) translateY(20px); }
        }
        
        .fluentgen-title {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        .fluentgen-title::before {
            content: "";
            margin-right: 0.4rem;
            display: inline-block;
            width: 0.8em;
            height: 0.8em;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1NDMuMTMgNTQyLjE2IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiPjxkZWZzPjxzdHlsZT4uc3RyMCB7c3Ryb2tlOiNiM2IzYjM7c3Ryb2tlLXdpZHRoOjEuMzc7c3Ryb2tlLW1pdGVybGltaXQ6MjIuOTI1Nn0uZmlsMSB7ZmlsbDojMDEwQjQ1fS5maWwzIHtmaWxsOiMwQTJGN0N9LmZpbDIge2ZpbGw6I0ZGQzYzRH0uZmlsMCB7ZmlsbDojZmZmO2ZpbGwtcnVsZTpub256ZXJvfTwvc3R5bGU+PC9kZWZzPjxnPjxwYXRoIGNsYXNzPSJmaWwwIHN0cjAiIGQ9Ik00NjIuMjggNDYyLjI4YzUyLjc4LC01Mi43OSA3OS4xOSwtMTIxLjk5IDc5LjE5LC0xOTEuMiAwLC0xNDkuMyAtMTIxLjEsLTI3MC4zOSAtMjcwLjM5LC0yNzAuMzkgLTE0OS4zLDAgLTI3MC4zOSwxMjEuMDkgLTI3MC4zOSwyNzAuMzkgMCwxNDkuMjkgMTIxLjA5LDI3MC4zOSAyNzAuMzksMjcwLjM5IDkwLjEzLDAgMTgwLjI2LDAgMjcwLjM5LDAgMCwwIC02My4yOSwtNjMuMDYgLTc5LjE5LC03OS4xOXoiLz48cGF0aCBjbGFzcz0iZmlsMSIgZD0iTTE5Mi42OSAzMTUuOTVjMS43OCwtMS4wOCAtMC43NCwtMi44OSAtMi4zMSwtMy41N2wyLjMxIDMuNTd6Ii8+PHBhdGggY2xhc3M9ImZpbDIiIGQ9Ik0zODMuMDEgMTUxLjUyYzAsMCAwLDAgMCwweiIvPjxwYXRoIGNsYXNzPSJmaWwzIiBkPSJNMTk0IDMzMC45M2M1LjE4LDMuODEgMTEuODgsNDUuNTMgMTUuMzQsNTUuMjQgNi44MiwxOS4xOCAyNC41OCwzMS40MiAzOS45NSwxMi4xMSA4LjM2LC0xMC41IDI2LjE2LC05Ni43OCAyNy42NywtMTEyLjg0IDkuOTQsOS41NCAxMS4wNywxMDcuMDggMjYuODEsMTI5LjE4IDE3LjA5LDI0IDM0LjkxLC0xLjM1IDM5LjA3LC0xOS41MSAyLjQ4LC0xMC44NSAxMS40MywtNTcuNzEgMTEuNCwtNjYuNTUgNy4xMyw2LjE5IDkuODIsMzQuMzggMjIuNDQsNDQuMTcgMjIuNzQsMTcuNjQgMzEuMywtNS4xMSA0MS43NCwtMTMuMDggNi42OSwtMC43MiAyMS41MywyLjA5IDI1Ljc5LC00LjU1IDUuMjIsLTguMTMgLTAuNDQsLTE3LjA3IC0xMC4wMywtMTcuNTcgLTQxLjkzLC0yLjE3IC0yOS40NiwxNS44MyAtNDEuNTUsMTguOTQgLTkuNzIsLTMuNCAtMTMsLTI3LjYzIC0xNy4yMSwtMzYuOTEgLTYuNDEsLTE0LjA5IC0yMi40NiwtMjAuNzkgLTM0LjQ1LC04LjQxIC0xNC4zMiwxNC43OSAtMTIuMzIsNzYgLTIxLjY1LDg4LjQxIC04LjUyLC0yNi4xOCAtMTEuMzEsLTEyNy41NCAtMzQuNDUsLTEzNi4zNiAtNDMuMTMsLTE2LjQ1IC0zNC44OCw5OC45NyAtNTAuNzYsMTE4LjIgLTYuMSw3LjM5IC0xNi40NSwtNTMuMDkgLTIwLjMyLC02MC41OCAtNS40NCwtMTAuNTEgLTE3LC0xNC44OSAtMjcuOTIsLTkuOTcgLTkuMzUsNC4yMSAtMTQuMDEsMTUuNTMgLTE5LjI5LDIzLjcxIC04LjY2LDEzLjM3IC0yMi4xLDQuNzkgLTM0LjI4LDguMzEgLTguMTEsMi4zNSAtMTIuMTYsMjAuMTIgOC45NCwyMC4zOSA1My4yOCwwLjcgNDEuMzYsLTI5LjIxIDUyLjc2LC0zMi4zM3oiLz48cGF0aCBjbGFzcz0iZmlsMiIgZD0iTTMyMS45OCAxMjAuODVjLTI5LjA2LDUuOTEgLTI5LjYxLDY3LjkyIC0zLjk1LDc2LjI2IDEwLjAxLDMuMjUgMjAuOTQsLTIuNzEgMTguMDEsNi45IC0xLjg5LDYuMTYgLTYuODQsMTMuNCAtMTIuNTgsMTYuNTQgLTIxLjk4LDEyLjAzIC04LjUyLDI2LjkxIDExLjA5LDIyLjI5IDMxLjA5LC03LjMzIDQ3LjQxLC0zNi45MiA0Ny44NSwtNjcuMiAwLjE5LC0xMi45OSAzLjM5LC00Mi41NSAtNy4xLC01MS4wNiAtNy44MywtNi4zNSAtNDMuMTcsLTUuNzkgLTUzLjMyLC0zLjczeiIvPjxwYXRoIGNsYXNzPSJmaWwyIiBkPSJNMTk1LjUxIDEyMC44NWMtMjkuMDYsNS45MSAtMjkuNjEsNjcuOTIgLTMuOTYsNzYuMjYgMTAuMDIsMy4yNSAyMC45NSwtMi43MSAxOC4wMSw2LjkgLTEuODgsNi4xNiAtNi44MywxMy40IC0xMi41NywxNi41NCAtMjEuOTgsMTIuMDMgLTguNTIsMjYuOTEgMTEuMDksMjIuMjkgMzEuMDgsLTcuMzMgNDcuNDEsLTM2LjkyIDQ3Ljg1LC02Ny4yIDAuMTksLTEyLjk5IDMuMzksLTQyLjU1IC03LjEsLTUxLjA2IC03LjgzLC02LjM1IC00My4xOCwtNS43OSAtNTMuMzIsLTMuNzN6Ii8+PC9nPjwvc3ZnPg==');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));
            animation: sparkleGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes sparkleGlow {
            0% { 
                filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));
                transform: scale(1);
            }
            100% { 
                filter: drop-shadow(0 0 16px rgba(255, 255, 255, 0.8));
                transform: scale(1.05);
            }
        }
        
        @keyframes titleGlow {
            0% { 
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.5),
                           0 0 40px rgba(255, 255, 255, 0.3),
                           0 0 60px rgba(255, 255, 255, 0.1);
            }
            100% { 
                text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
                           0 0 60px rgba(255, 255, 255, 0.5),
                           0 0 90px rgba(255, 255, 255, 0.2);
            }
        }
        
        .subtitle-text {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-style: normal;
            animation: subtitleFadeIn 1.5s ease-out 0.5s forwards;
        }
        
        @keyframes subtitleFadeIn {
            0% { 
                opacity: 0; 
                transform: translateY(20px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        .container {
            max-width: 600px !important;
            margin: 2rem auto !important;
            padding: 2rem !important;
            background: linear-gradient(145deg, rgba(13, 17, 23, 0.95) 0%, rgba(22, 27, 34, 0.9) 100%);
            border-radius: 1.5rem;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: auto !important;
            position: relative;
            backdrop-filter: blur(10px);
            animation: containerGlow 4s ease-in-out infinite alternate;
        }
        
        @keyframes containerGlow {
            0% { 
                box-shadow: 
                    0 20px 40px rgba(0, 0, 0, 0.3),
                    0 0 0 1px rgba(255, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }
            100% { 
                box-shadow: 
                    0 25px 50px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(255, 255, 255, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
            }
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 1rem;
            position: relative;
            background: linear-gradient(145deg, rgba(13, 17, 23, 0.8) 0%, rgba(22, 27, 34, 0.6) 100%);
            border: 2px solid #30363d;
            border-radius: 1rem;
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2; /* Garante que o grupo de input e o menu fiquem acima da infoBox */
        }

        .input-container {
            position: relative;
            flex: 1;
        }

        /* Painel de controle integrado */
        .control-panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.25rem 1rem;
            background: transparent;
            border: none;
            border-radius: 0 0 1rem 1rem;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1;
            font-size: 1rem;
        }

        .left-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Efeito de foco no painel quando o input está ativo */
        .input-group:focus-within {
            border-color: #58a6ff;
            box-shadow: 
                0 0 20px rgba(88, 166, 255, 0.4),
                0 0 40px rgba(88, 166, 255, 0.2);
        }

        .input-field {
            width: 100%;
            padding: 1rem 1rem 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #c9d1d9;
            outline: none;
            font-size: 1rem;
            position: relative;
            min-height: 3.5rem;
            max-height: 12rem;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-style: normal;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
        }

        /* Estilização moderna da barra de rolagem */
        .input-field::-webkit-scrollbar {
            width: 6px;
        }

        .input-field::-webkit-scrollbar-track {
            background: rgba(48, 54, 61, 0.3);
            border-radius: 3px;
        }

        .input-field::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #58a6ff 0%, #79c0ff 100%);
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .input-field::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #79c0ff 0%, #58a6ff 100%);
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.4);
        }

        .input-field {
            scrollbar-width: thin;
            scrollbar-color: #58a6ff rgba(48, 54, 61, 0.3);
        }
        
        .input-field:focus {
            outline: none;
        }
        
        .input-field::placeholder {
            color: rgba(201, 209, 217, 0.6);
            font-family: 'Inter', sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 1rem;
            animation: placeholderGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes inputPulse {
            0%, 100% { 
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 0 0 rgba(88, 166, 255, 0.4);
            }
            50% { 
                box-shadow: 
                    inset 0 2px 4px rgba(0, 0, 0, 0.3),
                    0 0 10px rgba(88, 166, 255, 0.2);
            }
        }
        
        @keyframes placeholderGlow {
            0% { color: rgba(201, 209, 217, 0.4); }
            100% { color: rgba(201, 209, 217, 0.8); }
        }

        .plus-icon {
            background: #30363d;
            border: none;
            color: #c9d1d9;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.6rem;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            line-height: 1;
        }
        
        .plus-icon:hover {
            background-color: #40464d;
            color: #ffffff;
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .floating-menu {
            position: absolute;
            top: calc(100% + 0.5rem); /* Aparece abaixo do painel de controle */
            left: 0.75rem; /* Alinhado com o centro do ícone + */
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            padding: 0.5rem;
            width: auto;
            min-width: fit-content;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        .floating-menu.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .floating-menu.show ~ .selected-mode-indicator,
        .floating-menu.show + * .selected-mode-indicator {
            z-index: 0 !important;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            color: #c9d1d9;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .menu-item:hover {
            background-color: #30363d;
        }
        
        .menu-item.active {
            background-color: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }
        
        .menu-item.active i {
            color: #58a6ff;
        }
        
        .active-check {
            margin-left: auto;
            color: #58a6ff;
            font-size: 0.9rem;
        }
        .menu-item i {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            width: 1.25rem;
            text-align: center;
        }

        .generate-icon {
            background: none;
            border: none;
            color: #79c0ff;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.6rem;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            line-height: 1;
        }
        
        .generate-icon:hover {
            color: #58a6ff;
            transform: scale(1.1) translateY(-2px);
        }
        
        .generate-icon:disabled {
            color: #6b7280;
            cursor: not-allowed;
            transform: none;
        }
        
        .selected-mode-indicator {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            pointer-events: none;
            opacity: 0;
            transform: translateY(0.5rem);
            transition: all 0.3s ease;
            line-height: 1;
            z-index: 1;
        }
        .selected-mode-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        .selected-mode-indicator i {
            font-size: 0.7rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Espaço entre o ícone e o texto */
        }
        .btn:hover {
            background-color: #2ea043;
        }
        .btn:disabled {
            background-color: #21262d;
            color: #8b949e;
            cursor: not-allowed;
        }
        .phrase-card {
            background-color: #0d1117;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #30363d;
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        
        @media (max-width: 480px) {
            .phrase-card {
                padding: 0.875rem;
                margin-bottom: 0.5rem;
            }
            
            .phrase-text-container:last-child {
                padding-bottom: 1.25rem; /* Reduzido drasticamente para eliminar espaço excessivo */
            }
            
            .phrase-card-content h3 {
                font-size: 1rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.3;
            }
            
            .phrase-card-content p {
                font-size: 0.85rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.3;
            }
            
            .phrase-actions {
                margin-bottom: 1.5rem; /* Aumenta margem inferior para criar espaço seguro */
                gap: 0.375rem; /* Reduz o gap para telas menores */
            }
            
            .action-btn, .speed-btn {
                padding: 0.5rem 0.6rem;
                font-size: 0.8rem;
                flex: 1;
                min-width: 0; /* Permite que os botões encolham */
            }
            
            .phrase-corner-actions {
                bottom: 0.25rem; /* Move para mais baixo */
                right: 0.875rem;
                gap: 0.375rem; /* Reduz o gap para telas menores */
                z-index: 10; /* Garante que fiquem acima de outros elementos */
            }
            
            @media (min-width: 376px) {
                .phrase-corner-actions {
                    position: absolute !important;
                    bottom: 0.25rem !important;
                    right: 0.875rem !important;
                }
            }
            
            .icon-btn {
                width: 2.25rem;
                height: 2.25rem;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 768px) {
            .phrase-card {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .phrase-text-container:last-child {
                padding-bottom: 0.5rem;
            }
            
            .phrase-card-content h3 {
                font-size: 0.95rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.3;
            }
            
            .phrase-card-content p {
                font-size: 0.8rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.3;
            }
            
            .phrase-actions {
                flex-direction: row;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
                align-items: center;
            }
            
            .action-btn, .speed-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
                flex: 1;
                min-width: 0;
            }
            
            .phrase-corner-actions {
                position: static !important;
                display: flex !important;
                gap: 0.5rem;
                margin-top: 0.5rem;
                justify-content: center;
                z-index: 10;
                bottom: auto !important;
                right: auto !important;
            }
            
            .icon-btn {
                width: 2.25rem;
                height: 2.25rem;
                font-size: 0.9rem;
            }
        }
        .phrase-corner-actions {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.375rem;
        }
        .phrase-text-container {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .phrase-text-container:last-child {
            margin-bottom: 1rem;
            padding-bottom: 2.5rem; /* Espaço para os ícones na parte inferior */
        }
        .phrase-card-content h3, .phrase-card-content p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            margin: 0;
            flex: 1;
        }
        .phrase-card-content h3 {
            font-weight: 700;
            font-size: 1.25rem;
            line-height: 1.4;
        }
        .phrase-card-content p {
            font-style: italic;
            color: #8b949e;
            line-height: 1.4;
        }
        .copy-icon {
            color: #4b5563;
            cursor: pointer;
            font-size: 0.8em;
            transition: color 0.2s ease-in-out;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        .copy-icon:hover {
            color: #c9d1d9;
        }
        .copy-tooltip {
            position: absolute;
            background-color: #21262d;
            color: #c9d1d9;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            border: 1px solid #30363d;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            white-space: nowrap;
        }
        .copy-tooltip.show {
            opacity: 1;
        }
        .phrase-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        .action-btn {
            background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-weight: 500;
            font-size: 0.8rem;
            box-shadow: 0 2px 6px rgba(88, 166, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .action-btn:hover {
            background: linear-gradient(135deg, #79c0ff 0%, #58a6ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }
        .action-btn:hover::before {
            left: 100%;
        }
        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(88, 166, 255, 0.3);
        }
        .action-btn:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed;
            transform: none !important;
        }
        .action-btn:disabled:hover {
            transform: none !important;
            box-shadow: 0 2px 8px rgba(88, 166, 255, 0.3) !important;
        }
        
        .speed-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-weight: 500;
            font-size: 0.8rem;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 80px;
            justify-content: center;
        }
        .speed-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .speed-btn:hover {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .speed-btn:hover::before {
            left: 100%;
        }
        .speed-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
        }
        .speed-btn:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed;
            transform: none !important;
        }
        .speed-btn:disabled:hover {
            transform: none !important;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3) !important;
        }
        
        .icon-btn {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.2);
            padding: 0.375rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            font-size: 0.875rem;
        }
        .icon-btn:hover {
            background: rgba(88, 166, 255, 0.2);
            color: #79c0ff;
            border-color: rgba(88, 166, 255, 0.3);
            transform: scale(1.05);
        }
        .icon-btn.repeat-active {
            background: rgba(229, 62, 62, 0.1);
            color: #e53e3e;
            border-color: rgba(229, 62, 62, 0.2);
        }
        .icon-btn.repeat-active:hover {
            background: rgba(229, 62, 62, 0.2);
            color: #c53030;
            border-color: rgba(229, 62, 62, 0.3);
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .toggle-label {
            color: #c9d1d9;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .toggle-switch {
            position: relative;
            width: 3rem;
            height: 1.5rem;
            background: #4a5568;
            border-radius: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }
        .toggle-switch:hover {
            background: #5a6578;
        }
        .toggle-switch.active {
            background: #10b981;
        }
        .toggle-switch.active:hover {
            background: #059669;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 1.25rem;
            height: 1.25rem;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(1.5rem);
        }
        .repeat-btn-active {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%) !important;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3) !important;
        }
        .repeat-btn-active:hover {
            background: linear-gradient(135deg, #c53030 0%, #e53e3e 100%) !important;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4) !important;
        }
        .info-box {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            text-align: center;
            color: #c9d1d9;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 400;
            font-style: normal;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .info-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.1), transparent);
            transition: left 0.8s ease;
        }
        .info-box.typing::before {
            left: 100%;
        }
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #58a6ff;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        .typing-cursor-futuristic {
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background: linear-gradient(45deg, #22c55e, #3b82f6);
            margin-left: 3px;
            animation: futuristicBlink 0.8s infinite, cursorGlow 2s infinite;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes futuristicBlink {
            0%, 50% { 
                opacity: 1; 
                transform: scaleY(1);
            }
            51%, 100% { 
                opacity: 0.3; 
                transform: scaleY(0.8);
            }
        }
        
        @keyframes cursorGlow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.8),
                           0 0 30px rgba(59, 130, 246, 0.3);
            }
        }

        .message-box {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        .mode-select {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #c9d1d9;
            outline: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 10px);
            background-position-y: center;
        }

        .highlightable {
            color: #79c0ff;
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
            transition: color 0.2s ease, text-shadow 0.2s ease;
            white-space: nowrap; /* Impede a quebra de linha */
        }
        .highlightable:hover {
            color: #a78bfa;
            text-shadow: 0 0 8px rgba(167, 139, 250, 0.5);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 17, 23, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #161b22;
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid #30363d;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.75rem;
        }

        #modalTitle {
            color: #a78bfa;
            font-size: 1.25rem;
            font-weight: 700;
            text-transform: capitalize;
        }

        #modalCloseBtn {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        #modalCloseBtn:hover {
            color: white;
            transform: rotate(90deg);
        }

        #modalBody {
            font-size: 1rem;
            line-height: 1.6;
            color: #c9d1d9;
        }

        #modalBody p {
            margin-top: 0.5rem;
        }

        #modalBody strong {
            color: #79c0ff;
            font-weight: 600;
        }

        @media (min-width: 1280px) {
            .container {
                max-width: 800px !important;
                padding: 1.25rem !important;
            }
        }
        
        @media (min-width: 1200px) and (max-width: 1279px) {
            .container {
                max-width: 500px;
                padding: 1.25rem;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1199px) {
            .container {
                max-width: 550px;
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                margin: 0.5rem;
                padding: 1.5rem;
            }
            
            .input-group {
                flex-direction: column;
                gap: 1rem;
            }
            
            .input-container {
                width: 100%;
            }
            
            .input-field {
                padding: 1rem 1rem 0.5rem 1rem;
                font-size: 1rem;
                min-height: 3.5rem;
                max-height: 9.75rem;
            }
            
            .control-panel {
                padding: 0.3rem 0.75rem;
            }
            
            .plus-icon {
                width: 2.25rem;
                height: 2.25rem;
                font-size: 1rem;
            }
            
            .generate-icon {
                width: 3rem;
                height: 3rem;
                font-size: 1.8rem;
            }
            
            .floating-menu {
                left: 0.5rem;
                top: calc(100% + 0.5rem);
                width: calc(100% - 1rem);
                max-width: none;
            }
            
            .menu-item {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .selected-mode-indicator {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 0.25rem;
                padding: 1rem;
            }
            
            h1 {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
            }
            
            .subtitle-text {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            .input-field {
                padding: 0.875rem 0.875rem 0.5rem 0.875rem;
                font-size: 0.95rem;
                min-height: 3rem;
                max-height: 8.25rem;
            }
            
            .control-panel {
                padding: 0.25rem 0.5rem;
            }
            
            .plus-icon {
                width: 2rem;
                height: 2rem;
                font-size: 0.9rem;
            }
            
            .generate-icon {
                width: 2.75rem;
                height: 2.75rem;
                font-size: 1.6rem;
            }
            
            .floating-menu {
                left: 0.25rem;
                top: calc(100% + 0.5rem);
                width: calc(100% - 0.5rem);
            }
            
            .selected-mode-indicator {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
            }
            
            .toggle-container {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .toggle-label {
                font-size: 0.85rem;
            }
            
            .toggle-switch {
                width: 2.5rem;
                height: 1.25rem;
            }
            
            .toggle-slider {
                width: 1rem;
                height: 1rem;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(1.25rem);
            }
        }

        /* Rodapé */
        .site-footer {
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            border-top: 1px solid #30363d;
            padding: 2rem 1rem;
            margin-top: 3rem;
            text-align: center;
        }

        .footer-content p {
            margin: 0.5rem 0;
            color: #8b949e;
            font-size: 0.9rem;
        }

        .footer-content p:first-child {
            font-size: 1rem;
            color: #c9d1d9;
        }

        .footer-content strong {
            color: #58a6ff;
            font-weight: 600;
        }

        .footer-subtitle {
            font-size: 0.8rem !important;
            color: #6e7681 !important;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .site-footer {
                padding: 1.5rem 1rem;
                margin-top: 2rem;
            }
            
            .footer-content p:first-child {
                font-size: 0.9rem;
            }
            
            .footer-subtitle {
                font-size: 0.75rem !important;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-4xl font-bold text-center mb-4 text-white animate-pulse">
            <span class="fluentgen-title">FluentGen</span>
        </h1>
        <p class="text-center text-gray-300 mb-8 text-lg leading-relaxed max-w-4xl mx-auto">
            <span class="subtitle-text">Gere Padrões de Frases em Inglês Com IA e Treine Sua Fluência — Áudio, Connected Speech e Exercícios Práticos.</span>
        </p>

        <div class="input-group">
            <div class="input-container">
                <textarea id="patternInput" class="input-field" placeholder="Digite sua consulta ou deixe a IA sugerir..." rows="1"></textarea>
                <div id="floatingMenu" class="floating-menu">
                    <div class="menu-item" data-mode="standard">
                        <i class="fas fa-comment-dots"></i>
                        <span>Frases Similares</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                    <div class="menu-item" data-mode="conversation">
                        <i class="fas fa-comments"></i>
                        <span>Conversa</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                    <div class="menu-item" data-mode="slang">
                        <i class="fas fa-fire"></i>
                        <span>Gírias e Linguagem Informal</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                     <div class="menu-item" data-mode="idioms">
                        <i class="fas fa-puzzle-piece"></i>
                        <span>Idioms e Phrasal Verbs</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                    <div class="menu-item" data-mode="specific-themes">
                        <i class="fas fa-palette"></i>
                        <span>Temas Específicos</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                    <div class="menu-item" data-mode="conversation-phrases">
                        <i class="fas fa-question-circle"></i>
                        <span>Frases de Conversação</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                    <div class="menu-item" data-mode="my-phrases">
                        <i class="fas fa-bookmark"></i>
                        <span>Frases do Usuário</span>
                        <i class="fa-solid fa-check active-check" style="display: none;"></i>
                    </div>
                </div>
            </div>
            <div class="control-panel">
                <div class="left-controls">
                    <button id="plusBtn" class="plus-icon">
                        <i class="fas fa-plus"></i>
                    </button>
                    <div id="selectedModeIndicator" class="selected-mode-indicator">
                        <i class="fas fa-comment-dots"></i>
                        <span>Frases Similares</span>
                    </div>
                </div>
                <button id="generateBtn" class="generate-icon">
                    <i class="fa-solid fa-circle-arrow-up"></i>
                </button>
            </div>
        </div>
        
        <div id="infoBox" class="info-box"></div>
        <div id="messageBox" class="hidden message-box"></div>
        <div class="flex justify-center mb-2">
            <div class="toggle-container">
                <span class="toggle-label">Connected Speech</span>
                <button id="connectSpeechToggle" class="toggle-switch">
                    <div class="toggle-slider"></div>
                </button>
            </div>
        </div>
        <div id="phrasesContainer">
        </div>

    </div>
    
    <!-- Modal para Explicações -->
    <div id="explanationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button id="modalCloseBtn">&times;</button>
            </div>
            <div id="modalBody">
            </div>
        </div>
    </div>


    <script type="module">
        // Variáveis globais
        let userId = 'local-user-' + Date.now();
        
        // Configuração da API do Gemini
        const GEMINI_API_KEY = "AIzaSyBVSjwHakwAsg5ePbjPbrC_gqF5P2X04tQ";

        // Cache e controle de TTS
        const audioCache = {};
        const inFlightAudioPromises = {};
        const ttsQueue = [];
        let isTtsProcessing = false;
        let lastRequestTime = 0;
        let consecutiveErrors = 0;

        // Estado do áudio em loop
        let currentLoopingAudio = null;
        let currentLoopingButton = null;

        // Estado da velocidade e modo do áudio
        let playbackRate = 1.0;
        let isConnectedSpeechMode = false;

        // UI elements
        const plusBtn = document.getElementById('plusBtn');
        const patternInput = document.getElementById('patternInput');
        const generateBtn = document.getElementById('generateBtn');
        const floatingMenu = document.getElementById('floatingMenu');
        const phrasesContainer = document.getElementById('phrasesContainer');
        const infoBox = document.getElementById('infoBox');
        const messageBox = document.getElementById('messageBox');
        const connectSpeechToggle = document.getElementById('connectSpeechToggle');
        const selectedModeIndicator = document.getElementById('selectedModeIndicator');
        const explanationModal = document.getElementById('explanationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalCloseBtn = document.getElementById('modalCloseBtn');


        let selectedMode = 'standard';
        let typingIntervalId = null;
        
        const siteDescriptions = [
            "Gere Padrões de Frases em Inglês Com IA e Treine Sua Fluência — Áudio, Connected Speech e Exercícios Práticos.",
            "Domine o Inglês com IA: Crie Frases Personalizadas, Pratique Pronúncia e Acelere Seu Aprendizado.",
            "Aprenda Inglês de Forma Inteligente: Gere Frases, Treine Áudio e Desenvolva Fluência Natural.",
            "Sua Plataforma de Inglês com IA: Frases Personalizadas, Áudio Nativo e Exercícios Interativos.",
            "Transforme Seu Inglês com IA: Gere Frases, Pratique Connected Speech e Alcance Fluência Real.",
        ];
        
        let usedDescriptions = new Set();
        
        function getRandomDescription() {
            if (usedDescriptions.size >= siteDescriptions.length) {
                usedDescriptions.clear();
            }
            
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * siteDescriptions.length);
            } while (usedDescriptions.has(randomIndex));
            
            usedDescriptions.add(randomIndex);
            return siteDescriptions[randomIndex];
        }
        
        function setRandomDescription() {
            const subtitleElement = document.querySelector('.subtitle-text');
            if (subtitleElement) {
                subtitleElement.textContent = getRandomDescription();
            }
        }

        const modeDescriptions = {
            'standard': "Pratique padrões de frases comuns. Complete as lacunas ou deixe a IA sugerir.",
            'conversation': "Gere diálogos naturais sobre qualquer tópico. Perfeito para conversação.",
            'slang': "Aprenda gírias e expressões informais. Fale como um nativo americano.",
            'idioms': "Explore expressões idiomáticas e phrasal verbs. Enriqueça seu vocabulário.",
            'specific-themes': "Foque em temas específicos. Frases e diálogos sobre assuntos de interesse.",
            'conversation-phrases': "Ideal para iniciantes! Este modo gera perguntas e respostas básicas e essenciais para a comunicação diária. Você pode digitar um tópico (ex: 'saudações') ou deixar a IA sugerir um.",
            'my-phrases': "Cole suas próprias frases (inglês na linha 1, português na linha 2, etc.) e o sistema organizará e gerará os áudios para você."
        };

        const modeOptions = {
            'standard': { icon: 'fas fa-comment-dots', name: 'Frases Similares' },
            'conversation': { icon: 'fas fa-comments', name: 'Conversa' },
            'slang': { icon: 'fas fa-fire', name: 'Gírias e Linguagem Informal' },
            'idioms': { icon: 'fas fa-puzzle-piece', name: 'Idioms e Phrasal Verbs' },
            'specific-themes': { icon: 'fas fa-palette', name: 'Temas Específicos' },
            'conversation-phrases': { icon: 'fas fa-question-circle', name: 'Frases de Conversação' },
            'my-phrases': { icon: 'fas fa-bookmark', name: 'Frases do Usuário' }
        };

        function initializeApp() {
            console.log("Aplicação inicializada em modo local. User ID:", userId);
        }

        function showMessage(msg, type = 'info') {
            messageBox.textContent = msg;
            messageBox.classList.remove('hidden');
        }

        function getExistingPhrases() {
            return JSON.parse(localStorage.getItem('existingPhrases') || '[]');
        }

        async function getSuggestion(systemPrompt, userQuery, fallback) {
             const apiKey = GEMINI_API_KEY;
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             const payload = {
                 contents: [{ parts: [{ text: userQuery }] }],
                 systemInstruction: { parts: [{ text: systemPrompt }] }
             };
             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });
             if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
             const result = await response.json();
             return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || fallback;
        }

        async function getSuggestedPattern() {
            return getSuggestion(
                "You are a language tutor. Provide a single, random, and creative simple English sentence pattern that can be completed with a verb. The output must be only the pattern string, with no other text or punctuation. Examples: 'I want to ___', 'He needs to ___', 'You have to ___', 'Can you help me ___', 'We should ___.",
                "Suggest a simple English sentence pattern.",
                "I want to ___"
            );
        }

        async function getSuggestedConversationTopic() {
             return getSuggestion(
                 "You are a language tutor. Provide a single, random, and simple everyday English conversation topic. The output must be only the topic string. Examples: 'ordering coffee', 'asking for directions', 'talking about the weather', 'making small talk'.",
                 "Suggest a simple English conversation topic.",
                 "making small talk"
             );
        }
        
        async function getSuggestedConversationQuestionTopic() {
            return getSuggestion(
                 "You are a language tutor. Provide a single, random, and simple everyday English conversation topic that involves questions and answers. The output must be only the topic string. Examples: 'asking for help', 'making plans', 'ordering food'.",
                 "Suggest a simple English conversation question topic.",
                 "asking for help"
             );
        }

        async function getSuggestedSpecificTheme() {
            return getSuggestion(
                 "You are a language tutor. Provide a single, random, and simple everyday English theme. The output must be only the theme string. Examples: 'cooking a meal', 'getting to know a new city', 'discussing technology', 'sports and hobbies', 'shopping for clothes'.",
                 "Suggest a specific English theme.",
                 "discussing a new movie"
            );
        }

        function toggleFloatingMenu() {
            const isMenuOpen = floatingMenu.classList.toggle('show');
            selectedModeIndicator.style.zIndex = isMenuOpen ? '0' : '1';
        }

        function typeText(element, text) {
            if (typingIntervalId) {
                clearInterval(typingIntervalId);
                typingIntervalId = null;
            }
            element.innerHTML = '';
            element.classList.add('typing');
            let i = 0;
            typingIntervalId = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typingIntervalId);
                    typingIntervalId = null;
                    element.classList.remove('typing');
                }
            }, 30);
        }

        function selectMode(mode) {
            selectedMode = mode;
            floatingMenu.classList.remove('show');
            selectedModeIndicator.style.zIndex = '1';
            
            document.querySelectorAll('.menu-item').forEach(item => {
                const checkIcon = item.querySelector('.active-check');
                const isActive = item.dataset.mode === mode;
                item.classList.toggle('active', isActive);
                if (checkIcon) checkIcon.style.display = isActive ? 'inline-block' : 'none';
            });
            
            const modeOption = modeOptions[mode];
            const indicatorIcon = selectedModeIndicator.querySelector('i');
            const indicatorText = selectedModeIndicator.querySelector('span');
            indicatorIcon.className = modeOption.icon;
            indicatorText.textContent = modeOption.name;
            
            selectedModeIndicator.classList.add('show');

            // Limpa o input ao trocar de modo e ajusta a altura do textarea
            patternInput.value = '';
            autoResizeTextarea(patternInput);
            
            const placeholders = {
                'standard': 'Digite um padrão de frase ou deixe a IA sugerir...',
                'conversation': 'Digite um tópico de conversa ou deixe a IA escolher...',
                'slang': 'Digite um tema para gírias ou deixe a IA sugerir...',
                'idioms': 'Digite um tema para idioms/phrasal verbs ou deixe a IA escolher...',
                'specific-themes': 'Digite um tema específico ou deixe a IA escolher...',
                'conversation-phrases': 'Digite um tópico de conversação ou deixe a IA sugerir...',
                'my-phrases': 'Cole suas frases (inglês e tradução).'
            };
            
            patternInput.placeholder = placeholders[mode];
            typeText(infoBox, modeDescriptions[mode]);
        }

        async function handleGenerate() {
            stopLoopingAudio();

            let input = patternInput.value.trim();
            phrasesContainer.innerHTML = '';
            messageBox.classList.add('hidden');

            if (selectedMode === 'my-phrases') {
                if (!input) {
                    showMessage("Por favor, insira as frases no campo de texto. Formato: inglês na linha 1, português na linha 2, etc.");
                    return;
                }
                
                try {
                    const lines = input.split('\n').filter(line => line.trim() !== '');
                    if (lines.length === 0 || lines.length % 2 !== 0) {
                        showMessage("Formato inválido. Forneça um número par de linhas, alternando entre inglês e português.");
                        return;
                    }

                    const userPhrases = [];
                    for (let i = 0; i < lines.length; i += 2) {
                        userPhrases.push({
                            english: lines[i].trim(),
                            portuguese: lines[i + 1].trim()
                        });
                    }
                    renderPhrases(userPhrases);
                } catch (error) {
                    console.error("Erro ao processar frases do usuário:", error);
                    showMessage(`Erro ao organizar suas frases.`);
                }
                return;
            }
            
            toggleButtonState(true);

            let systemPrompt, userQuery, responseSchema;
            const baseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: { "english": { "type": "STRING" }, "portuguese": { "type": "STRING" } }
                }
            };

            switch (selectedMode) {
                case 'standard':
                    if (!input) input = await getSuggestedPattern();
                    systemPrompt = "You are a language tutor. Generate exactly 10 unique English sentences following the user's pattern, with Portuguese translations. Sentences must be new, avoiding provided examples. Focus on common verbs and daily-life situations. Output must be a JSON array of objects with 'english' and 'portuguese' keys. Use varied verbs. No introductory text, just the JSON.";
                    userQuery = `Pattern: ${input}. Avoid: ${JSON.stringify(getExistingPhrases())}. Generate 10 new sentences.`;
                    responseSchema = baseSchema;
                    break;
                case 'conversation':
                    if (!input) input = await getSuggestedConversationTopic();
                    systemPrompt = "You are a language tutor. Generate 10 lines of a natural-sounding English conversation on a single topic, with Portuguese translations. Output must be a JSON array of objects with 'english' and 'portuguese' keys. No introductory text, just the JSON.";
                    userQuery = `Generate a conversation about: ${input}.`;
                    responseSchema = baseSchema;
                    break;
                case 'slang':
                    if (!input) input = await getSuggestedConversationTopic();
                    systemPrompt = "You are a language tutor specializing in modern, informal American English. Generate 10 lines of a highly informal conversation with common American slang and idioms. Include an expletive for anger/frustration. Output must be a JSON array of objects with 'english' and 'portuguese' keys, capturing the informal tone. No introductory text, just the JSON.";
                    userQuery = `Generate an informal conversation about: ${input}.`;
                    responseSchema = baseSchema;
                    break;
                case 'idioms':
                     if (!input) input = await getSuggestedConversationTopic();
                    systemPrompt = "You are a language tutor. Generate exactly 10 unique and concise English sentences, alternating between a common idiom and a common phrasal verb. The sentences should be short and easy to understand, suitable for flashcard study (like Anki). For each, provide its Portuguese translation, identify the specific idiom/phrasal verb (without any markdown formatting), its type ('idiom' or 'phrasal verb'), and a short, simple explanation in Portuguese. Output must be a JSON array of objects with keys: 'english', 'portuguese', 'highlight', 'type', and 'explanation'. No introductory text, just the JSON.";
                    userQuery = `Generate sentences on the theme: ${input}. If no theme, choose common topics.`;
                    responseSchema = {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "english": { "type": "STRING" },
                                "portuguese": { "type": "STRING" },
                                "highlight": { "type": "STRING" },
                                "type": { "type": "STRING" },
                                "explanation": { "type": "STRING" }
                            }
                        }
                    };
                    break;
                case 'specific-themes':
                    if (!input) input = await getSuggestedSpecificTheme();
                    systemPrompt = "You are a language tutor. Generate 10 English phrases about a specific theme, mixing single statements and short conversations. Provide Portuguese translations. Output must be a JSON array of objects with 'english' and 'portuguese' keys. No introductory text, just the JSON.";
                    userQuery = `Generate phrases and short conversations about: ${input}.`;
                    responseSchema = baseSchema;
                    break;
                case 'conversation-phrases':
                    if (!input) input = await getSuggestedConversationQuestionTopic();
                    systemPrompt = "You are a language tutor. Generate 10 lines of a natural English conversation with common questions and answers. Provide Portuguese translations. Output must be a JSON array of objects with 'english' and 'portuguese' keys. No introductory text, just the JSON.";
                    userQuery = `Generate a conversation about: ${input}.`;
                    responseSchema = baseSchema;
                    break;
            }
            patternInput.value = input;
            
            try {
                const apiKey = GEMINI_API_KEY;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json", responseSchema }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                const candidates = result.candidates;

                if (candidates?.[0]?.content?.parts?.[0]?.text) {
                    const parsedPhrases = JSON.parse(candidates[0].content.parts[0].text);
                    if (parsedPhrases.length > 0) {
                        renderPhrases(parsedPhrases);
                        savePhrasesToLocalStorage(parsedPhrases, input);
                    } else {
                        showMessage("A IA não conseguiu gerar novas frases. Tente um padrão ou tópico diferente.");
                    }
                } else {
                    showMessage("A IA não retornou um resultado válido.");
                }

            } catch (error) {
                console.error("Erro ao gerar frases:", error);
                showMessage(`Erro: ${error.message}. Tente novamente.`);
            } finally {
                toggleButtonState(false);
            }
        }

        function renderPhrases(phrases) {
            phrasesContainer.innerHTML = '';
            phrases.forEach(phrase => {
                const phraseCard = document.createElement('div');
                phraseCard.className = 'phrase-card';

                let englishSentence = phrase.english;
                if (phrase.highlight && phrase.explanation && phrase.type) {
                    const cleanHighlight = phrase.highlight.replace(/\*/g, '');
                    const regex = new RegExp(`(${cleanHighlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'i');
                    englishSentence = englishSentence.replace(regex, 
                        `<strong class="highlightable" 
                                data-highlight="${cleanHighlight}" 
                                data-type="${phrase.type}" 
                                data-explanation="${phrase.explanation}">$1</strong>`);
                }

                phraseCard.innerHTML = `
                    <div class="phrase-card-content">
                        <div class="phrase-text-container">
                            <h3>${englishSentence}</h3>
                            <i class="fa-regular fa-copy copy-icon cursor-pointer" data-text-to-copy="${phrase.english}"></i>
                        </div>
                        <div class="phrase-text-container">
                            <p>${phrase.portuguese}</p>
                            <i class="fa-regular fa-copy copy-icon cursor-pointer" data-text-to-copy="${phrase.portuguese}"></i>
                        </div>
                    </div>
                    <div class="phrase-actions flex-wrap">
                        <button class="action-btn play-audio-btn" data-original-text="Ouvir" data-original-icon="fas fa-volume-up">
                            <i class="fas fa-volume-up"></i> <span>Ouvir</span>
                        </button>
                        <button class="speed-btn" onclick="cyclePlaybackRate()">
                            <i class="fas fa-tachometer-alt"></i> <span id="speed-text">1.0x</span>
                        </button>
                    </div>
                    <div class="phrase-corner-actions">
                        <button class="icon-btn repeat-audio-btn" data-original-icon="fas fa-redo" title="Repetir">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="icon-btn download-audio-btn" data-original-icon="fas fa-download" title="Baixar">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
                phrasesContainer.appendChild(phraseCard);

                // Envolver as palavras em spans clicáveis para tocar áudio por palavra
                const titleEl = phraseCard.querySelector('h3');
                if (titleEl) wrapWordsForAudio(titleEl);
            });

            document.querySelectorAll('.play-audio-btn').forEach((btn, index) => btn.addEventListener('click', () => { stopLoopingAudio(); playAudio(phrases[index].english, btn); }));
            document.querySelectorAll('.repeat-audio-btn').forEach((btn, index) => btn.addEventListener('click', () => toggleRepeatAudio(phrases[index].english, btn)));
            document.querySelectorAll('.copy-icon').forEach(icon => icon.addEventListener('click', (e) => copyTextToClipboard(e.target.dataset.textToCopy, e.target)));
            document.querySelectorAll('.download-audio-btn').forEach((btn, index) => btn.addEventListener('click', () => { stopLoopingAudio(); downloadAudio(phrases[index].english, btn); }));
            
            updateSpeedButtonText();
        }

        function wrapWordsForAudio(rootElement) {
            const wordRegex = /(\b[\w']+\b)/g; // palavras (inclui apóstrofos em contrações)
            const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null);
            const textNodes = [];
            while (walker.nextNode()) {
                const node = walker.currentNode;
                // Ignorar nós de texto vazios/espacos
                if (!node.nodeValue || !node.nodeValue.trim()) continue;
                textNodes.push(node);
            }
            textNodes.forEach(textNode => {
                const parts = textNode.nodeValue.split(wordRegex);
                const fragment = document.createDocumentFragment();
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!part) continue;
                    if (wordRegex.test(part)) {
                        const span = document.createElement('span');
                        span.className = 'word-audio cursor-pointer';
                        span.dataset.word = part;
                        span.textContent = part;
                        fragment.appendChild(span);
                    } else {
                        fragment.appendChild(document.createTextNode(part));
                    }
                }
                textNode.parentNode.replaceChild(fragment, textNode);
            });
        }

        let lastWordClickTs = 0;
        async function playWordAudio(text) {
            const now = Date.now();
            if (now - lastWordClickTs < 500) return; // Aumentar debounce para 500ms
            lastWordClickTs = now;
            try {
                const audioUrl = await getAudioUrlThrottled(text);
                const audio = new Audio(audioUrl);
                audio.playbackRate = playbackRate;
                audio.play();
            } catch (error) {
                console.error('Erro ao tocar palavra:', error);
                if (error.message.includes('429')) {
                    showMessage('Muitas solicitações de áudio. Aguarde alguns segundos e tente novamente.');
                } else {
                    showMessage('Erro ao reproduzir áudio. Tente novamente em alguns segundos.');
                }
            }
        }
        
        function savePhrasesToLocalStorage(phrases, pattern) {
            try {
                const existingPhrases = JSON.parse(localStorage.getItem('existingPhrases') || '[]');
                const newPhrases = phrases.map(phrase => ({ ...phrase, pattern, timestamp: Date.now() }));
                let updatedPhrases = [...existingPhrases, ...newPhrases];
                if (updatedPhrases.length > 100) {
                    updatedPhrases = updatedPhrases.slice(updatedPhrases.length - 100);
                }
                localStorage.setItem('existingPhrases', JSON.stringify(updatedPhrases));
            } catch (e) {
                console.error("Erro ao salvar no localStorage:", e);
            }
        }
        
        function toggleButtonState(isLoading) {
            const iconElement = generateBtn.querySelector('i');
            generateBtn.disabled = isLoading;
            iconElement.className = isLoading ? 'fas fa-spinner fa-spin' : 'fa-solid fa-circle-arrow-up';
        }
        
        async function copyTextToClipboard(text, icon) {
            try {
                await navigator.clipboard.writeText(text);
                showCopyTooltip(icon, "Copiado!");
            } catch (err) {
                console.error('Erro ao copiar:', err);
                showCopyTooltip(icon, "Erro ao copiar");
            }
        }

        function showCopyTooltip(icon, message) {
            document.querySelector('.copy-tooltip')?.remove();
            const tooltip = document.createElement('div');
            tooltip.className = 'copy-tooltip';
            tooltip.textContent = message;
            document.body.appendChild(tooltip);
            const iconRect = icon.getBoundingClientRect();
            tooltip.style.left = `${iconRect.left + window.scrollX + (iconRect.width / 2) - (tooltip.offsetWidth / 2)}px`;
            tooltip.style.top = `${iconRect.top + window.scrollY - tooltip.offsetHeight - 5}px`;
            setTimeout(() => tooltip.classList.add('show'), 10);
            setTimeout(() => {
                tooltip.classList.remove('show');
                setTimeout(() => tooltip.remove(), 200);
            }, 2000);
            if (message === "Copiado!") {
                icon.className = 'fas fa-check copy-icon';
                setTimeout(() => { icon.className = 'fa-regular fa-copy copy-icon'; }, 2000);
            }
        }

        window.cyclePlaybackRate = function() {
            const speeds = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
            playbackRate = speeds[(speeds.indexOf(playbackRate) + 1) % speeds.length];
            updateSpeedButtonText();
            if (currentLoopingAudio) currentLoopingAudio.playbackRate = playbackRate;
        };

        function updateSpeedButtonText() {
            document.querySelectorAll('#speed-text').forEach(text => {
                text.textContent = `${playbackRate.toFixed(2)}x`;
            });
        }

        function toggleButtonLoading(btn, isLoading) {
            const icon = btn.querySelector('i');
            icon.className = isLoading ? 'fas fa-spinner fa-spin' : btn.dataset.originalIcon;
            btn.disabled = isLoading;
        }

        async function playAudio(text, btn) {
            toggleButtonLoading(btn, true);
            try {
                const audioUrl = await getAudioUrlThrottled(text);
                const audio = new Audio(audioUrl);
                audio.playbackRate = playbackRate;
                audio.play();
                audio.onended = () => toggleButtonLoading(btn, false);
            } catch (error) {
                console.error("Erro ao tocar áudio:", error);
                if (error.message.includes('429')) {
                    showMessage("Muitas solicitações de áudio. Aguarde alguns segundos e tente novamente.");
                } else {
                    showMessage("Erro ao tocar o áudio. Tente novamente em alguns segundos.");
                }
                toggleButtonLoading(btn, false);
            }
        }
        
        async function toggleRepeatAudio(text, btn) {
            if (currentLoopingButton === btn) {
                stopLoopingAudio();
                return;
            }
            if (currentLoopingAudio) stopLoopingAudio();

            toggleButtonLoading(btn, true);
            try {
                const audioUrl = await getAudioUrlThrottled(text);
                const audio = new Audio(audioUrl);
                audio.playbackRate = playbackRate;
                audio.loop = true;
                audio.play();
                currentLoopingAudio = audio;
                currentLoopingButton = btn;
                btn.classList.add('repeat-active');
            } catch (error) {
                console.error("Erro ao repetir áudio:", error);
                if (error.message.includes('429')) {
                    showMessage("Muitas solicitações de áudio. Aguarde alguns segundos e tente novamente.");
                } else {
                    showMessage("Erro ao repetir o áudio. Tente novamente em alguns segundos.");
                }
                stopLoopingAudio();
            } finally {
                toggleButtonLoading(btn, false);
            }
        }
        
        function stopLoopingAudio() {
            if (currentLoopingAudio) {
                currentLoopingAudio.pause();
                currentLoopingAudio.loop = false;
                currentLoopingAudio = null;
            }
            if (currentLoopingButton) {
                currentLoopingButton.classList.remove('repeat-active');
                currentLoopingButton = null;
            }
        }

        async function downloadAudio(text, btn) {
            toggleButtonLoading(btn, true);
            try {
                const audioUrl = await getAudioUrlThrottled(text);
                const link = document.createElement('a');
                const sanitizedFilename = text.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 50).toLowerCase();
                link.href = audioUrl;
                link.download = `${sanitizedFilename || 'audio'}.wav`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Erro ao baixar áudio:", error);
                if (error.message.includes('429')) {
                    showMessage("Muitas solicitações de áudio. Aguarde alguns segundos e tente novamente.");
                } else {
                    showMessage("Erro ao baixar o áudio. Tente novamente em alguns segundos.");
                }
            } finally {
                toggleButtonLoading(btn, false);
            }
        }
        
        connectSpeechToggle.addEventListener('click', () => {
            stopLoopingAudio();
            isConnectedSpeechMode = !isConnectedSpeechMode;
            connectSpeechToggle.classList.toggle('active', isConnectedSpeechMode);
        });

        async function generateAudioUrl(text) {
            const cacheKey = `${text}-${isConnectedSpeechMode ? 'connected' : 'default'}`;
            if (audioCache[cacheKey]) return audioCache[cacheKey];

            let voiceName = isConnectedSpeechMode ? "Zubenelgenubi" : "Puck"; 
            let textToSynthesize = isConnectedSpeechMode ? `Say this in a fast, casual, connected speech style: ${text}` : text;
            
            const apiKey = GEMINI_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: textToSynthesize }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName } } }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (!audioData || !mimeType?.startsWith("audio/")) throw new Error("Dados de áudio inválidos na resposta da API.");
            
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            
            audioCache[cacheKey] = audioUrl;
            return audioUrl;
        }

        function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

        async function generateAudioUrlWithRetry(text, attempts = 3) {
            let lastError;
            for (let i = 0; i <= attempts; i++) {
                try {
                    return await generateAudioUrl(text);
                } catch (e) {
                    lastError = e;
                    if (i === attempts) break;
                    // Backoff exponencial mais agressivo: 1s, 3s, 6s
                    const delay = Math.min(1000 * Math.pow(2, i), 6000);
                    console.log(`Tentativa ${i + 1} falhou, aguardando ${delay}ms...`);
                    await sleep(delay);
                }
            }
            throw lastError;
        }

        async function getAudioUrlThrottled(text) {
            const cacheKey = `${text}-${isConnectedSpeechMode ? 'connected' : 'default'}`;
            if (audioCache[cacheKey]) return audioCache[cacheKey];
            if (inFlightAudioPromises[cacheKey]) return inFlightAudioPromises[cacheKey];
            return new Promise((resolve, reject) => {
                ttsQueue.push({ cacheKey, text, resolve, reject });
                processTtsQueue();
            });
        }

        async function processTtsQueue() {
            if (isTtsProcessing) return;
            isTtsProcessing = true;
            try {
                while (ttsQueue.length) {
                    const { cacheKey, text, resolve, reject } = ttsQueue.shift();
                    if (audioCache[cacheKey]) { 
                        resolve(audioCache[cacheKey]); 
                        continue; 
                    }
                    if (!inFlightAudioPromises[cacheKey]) {
                        inFlightAudioPromises[cacheKey] = (async () => {
                            try {
                                const url = await generateAudioUrlWithRetry(text, 3);
                                audioCache[cacheKey] = url;
                                consecutiveErrors = 0; // Reset contador de erros
                                return url;
                            } catch (e) {
                                consecutiveErrors++;
                                throw e;
                            } finally {
                                delete inFlightAudioPromises[cacheKey];
                            }
                        })();
                    }
                    try {
                        const url = await inFlightAudioPromises[cacheKey];
                        resolve(url);
                    } catch (e) {
                        reject(e);
                    }
                    
                    // Espaçamento dinâmico baseado em erros consecutivos
                    const baseDelay = 1500;
                    const errorMultiplier = Math.min(consecutiveErrors * 0.5, 3); // Max 3x delay
                    const dynamicDelay = baseDelay + (baseDelay * errorMultiplier);
                    
                    // Garantir mínimo de 2s entre requisições
                    const timeSinceLastRequest = Date.now() - lastRequestTime;
                    const remainingDelay = Math.max(dynamicDelay - timeSinceLastRequest, 2000);
                    
                    console.log(`Aguardando ${remainingDelay}ms antes da próxima requisição...`);
                    await sleep(remainingDelay);
                    lastRequestTime = Date.now();
                }
            } finally {
                isTtsProcessing = false;
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bytesPerSample = 2;
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            
            // WAV header
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, 36 + pcmData.byteLength, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
            view.setUint16(32, numChannels * bytesPerSample, true);
            view.setUint16(34, bytesPerSample * 8, true);
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, pcmData.byteLength, true);

            new Uint8Array(buffer, 44).set(new Uint8Array(pcmData.buffer));
            return new Blob([view], { type: 'audio/wav' });
        }
        
        // Modal functions
        function openModal(title, highlight, explanation) {
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p><strong>${highlight}</strong>: ${explanation}</p>`;
            explanationModal.classList.add('show');
        }

        function closeModal() {
            explanationModal.classList.remove('show');
        }
        
        generateBtn.addEventListener('click', handleGenerate);
        plusBtn.addEventListener('click', toggleFloatingMenu);

        document.querySelectorAll('.menu-item').forEach(item => item.addEventListener('click', () => selectMode(item.dataset.mode)));

        document.addEventListener('click', (e) => {
            if (!floatingMenu.contains(e.target) && !plusBtn.contains(e.target)) {
                floatingMenu.classList.remove('show');
                selectedModeIndicator.style.zIndex = '1';
            }
        });

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const scrollHeight = textarea.scrollHeight;
            let maxHeight = 192; // 12rem
            if (window.innerWidth <= 480) maxHeight = 132; // 8.25rem
            else if (window.innerWidth <= 768) maxHeight = 156; // 9.75rem
            textarea.style.height = `${Math.min(scrollHeight, maxHeight)}px`;
            textarea.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden';
        }

        patternInput.addEventListener('input', () => autoResizeTextarea(patternInput));
        patternInput.addEventListener('paste', () => setTimeout(() => autoResizeTextarea(patternInput), 10));
        window.addEventListener('resize', () => autoResizeTextarea(patternInput));

        phrasesContainer.addEventListener('click', (e) => {
            const wordTarget = e.target.closest('.word-audio');
            if (wordTarget) {
                stopLoopingAudio();
                playWordAudio(wordTarget.dataset.word);
                return;
            }
            const highlightTarget = e.target.closest('.highlightable');
            if (highlightTarget) {
                const { highlight, type, explanation } = highlightTarget.dataset;
                openModal(type, highlight, explanation);
            }
        });

        modalCloseBtn.addEventListener('click', closeModal);
        explanationModal.addEventListener('click', (e) => {
            if (e.target === explanationModal) closeModal();
        });


        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            typeText(infoBox, modeDescriptions[selectedMode]);
            autoResizeTextarea(patternInput);
            selectedModeIndicator.classList.add('show');
            const defaultItem = document.querySelector(`[data-mode="${selectedMode}"]`);
            if (defaultItem) {
                defaultItem.classList.add('active');
                defaultItem.querySelector('.active-check').style.display = 'inline-block';
            }
            setRandomDescription();
        });
    </script>

    <!-- Rodapé -->
    <footer class="site-footer">
        <div class="footer-content">
            <p>Criado com ❤️ por <strong>Genilson Ferreira</strong></p>
            <p class="footer-subtitle">Desenvolvedor Full Stack & Entusiasta de IA</p>
        </div>
    </footer>

</body>
</html>

